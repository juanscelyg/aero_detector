<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro">

  <xacro:property name="prop_mesh_file" value="file://$(find aero_detector)/meshes/iris_prop_cw.dae" />
  <xacro:property name="prop_mass" value="0.005" />

  <xacro:macro name="default_parachute" params="namespace">
    <gazebo>
      <plugin name='${namespace}_parachute_plugin' filename='libgazebo_parachute_plugin.so'>
        <robotNamespace>${namespace}</robotNamespace>
        <commandSubTopic>/gazebo/command/motor_speed</commandSubTopic>
        <motorNumber>4</motorNumber>
      </plugin>
    </gazebo>
  </xacro:macro>
  <xacro:default_parachute namespace="${namespace}"></xacro:default_parachute>
  />
  <xacro:macro name="thruster_macro" params="namespace thruster_id *origin turningDirection">

    <joint name="${namespace}/rotor_${thruster_id}_joint" type="continuous">
      <xacro:insert_block name="origin" />
      <axis xyz="0 0 1" />
      <parent link="${namespace}/base_link" />
      <child link="${namespace}/rotor_${thruster_id}" />
    </joint>

    <link name='${namespace}/rotor_${thruster_id}'>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <mesh filename="${prop_mesh_file}" scale="1 1 1" />
        </geometry>
      </visual>

      <collision>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <cylinder length="0.005" radius="0.128" />
        </geometry>
      </collision>

      <inertial>
        <mass value="${prop_mass}" />
        <xacro:insert_block name="origin" />
        <inertia ixx="9.75e-07" ixy="0" ixz="0" iyy="0.000273104" iyz="0" izz="0.000274004" />
      </inertial>
    </link>

    <gazebo>
      <plugin name='${namespace}_${thruster_id}_model' filename='libgazebo_motor_model.so'>
        <robotNamespace>${namespace}</robotNamespace>
        <jointName>${namespace}/thruster_${thruster_id}_joint</jointName>
        <linkName>${namespace}/thruster_${thruster_id}</linkName>
        <turningDirection>${turningDirection}</turningDirection>
        <timeConstantUp>0.0125</timeConstantUp>
        <timeConstantDown>0.025</timeConstantDown>
        <maxRotVelocity>1100</maxRotVelocity>
        <motorConstant>8.54858e-06</motorConstant>
        <momentConstant>0.06</momentConstant>
        <commandSubTopic>/gazebo/command/motor_speed</commandSubTopic>
        <motorNumber>${thruster_id}</motorNumber>
        <rotorDragCoefficient>0.000806428</rotorDragCoefficient>
        <rollingMomentCoefficient>1e-06</rollingMomentCoefficient>
        <motorSpeedPubTopic>/motor_speed/${thruster_id}</motorSpeedPubTopic>
        <rotorVelocitySlowdownSim>10</rotorVelocitySlowdownSim>
      </plugin>
    </gazebo>

  </xacro:macro>

  <xacro:thruster_macro namespace="${namespace}" thruster_id="0" turningDirection="ccw">
    <origin xyz="0.265 -0.265 0.35" rpy="0 0 0" />
  </xacro:thruster_macro>

  <xacro:thruster_macro namespace="${namespace}" thruster_id="1" turningDirection="ccw">
    <origin xyz="-0.265 0.265 0.35" rpy="0 0 0" />
  </xacro:thruster_macro>

  <xacro:thruster_macro namespace="${namespace}" thruster_id="2" turningDirection="cw">
    <origin xyz="0.265 0.265 0.35" rpy="0 0 0" />
  </xacro:thruster_macro>

  <xacro:thruster_macro namespace="${namespace}" thruster_id="3" turningDirection="cw">
    <origin xyz="-0.265 -0.265 0.35" rpy="0 0 0" />
  </xacro:thruster_macro>

</robot>